<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fitness Coach</title>
    <meta name="description"
        content="Your personal AI-powered fitness coach with 20 exercises, pose detection, and workout tracking.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- MediaPipe CDN (WASM-based, stays as CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <!-- Vue 3 CDN (full build with template compiler) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div id="app" v-cloak>

        <!-- ============================================ -->
        <!-- LOGIN PAGE                                    -->
        <!-- ============================================ -->
        <div v-if="currentPage === 'login'" class="login-page">
            <div class="login-container">
                <div class="login-header">
                    <div class="login-icon">üèãÔ∏è</div>
                    <h1>AI Fitness Coach</h1>
                    <p class="login-subtitle">Your personal AI-powered trainer</p>
                </div>

                <div class="login-form">
                    <div class="login-tabs">
                        <button @click="authMode = 'login'" :class="{ active: authMode === 'login' }">Login</button>
                        <button @click="authMode = 'signup'" :class="{ active: authMode === 'signup' }">Sign Up</button>
                    </div>

                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" v-model="authUsername" placeholder="Enter username" @keyup.enter="handleAuth"
                            id="username-input">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" v-model="authPassword" placeholder="Enter password"
                            @keyup.enter="handleAuth" id="password-input">
                    </div>

                    <div v-if="authError" class="auth-error">{{ authError }}</div>

                    <button @click="handleAuth" class="auth-btn" id="auth-submit">
                        {{ authMode === 'login' ? 'Login' : 'Create Account' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- DASHBOARD PAGE                                -->
        <!-- ============================================ -->
        <div v-if="currentPage === 'dashboard'" class="dashboard-page">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <span class="app-logo">üèãÔ∏è</span>
                    <span class="app-name">AI Fitness Coach</span>
                </div>
                <div class="top-bar-right">
                    <span class="user-greeting">Hey, <strong>{{ currentUser }}</strong></span>
                    <button @click="handleLogout" class="logout-btn" id="logout-btn">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button @click="dashboardTab = 'exercises'" :class="{ active: dashboardTab === 'exercises' }"
                    class="nav-tab">üèãÔ∏è Exercises</button>
                <button @click="dashboardTab = 'profile'" :class="{ active: dashboardTab === 'profile' }"
                    class="nav-tab">üë§ Profile</button>
                <button @click="dashboardTab = 'leaderboard'; refreshLeaderboard()"
                    :class="{ active: dashboardTab === 'leaderboard' }" class="nav-tab">üèÜ Leaderboard</button>
            </div>

            <!-- ========== EXERCISES TAB ========== -->
            <div v-if="dashboardTab === 'exercises'">
                <!-- Today's Stats -->
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value">{{ todayStats.totalExercises }}</div>
                        <div class="stat-label">Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ todayStats.totalReps }}</div>
                        <div class="stat-label">Total Reps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ formatDuration(todayStats.totalDuration) }}</div>
                        <div class="stat-label">Duration</div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="category-filter">
                    <button @click="selectedCategory = 'ALL'" :class="{ active: selectedCategory === 'ALL' }"
                        class="cat-btn">All</button>
                    <button v-for="(cat, key) in categories" :key="key" @click="selectedCategory = key"
                        :class="{ active: selectedCategory === key }" class="cat-btn"
                        :style="selectedCategory === key ? { background: cat.color } : {}">
                        {{ cat.icon }} {{ cat.label }}
                    </button>
                </div>

                <!-- Exercise Grid -->
                <div class="exercise-grid">
                    <div v-for="ex in filteredExercises" :key="ex.id" class="exercise-card"
                        @click="startExercise(ex.id)" :style="{ '--accent': getCategoryColor(ex.category) }">
                        <div class="exercise-icon">{{ ex.icon }}</div>
                        <div class="exercise-info">
                            <h3>{{ ex.name }}</h3>
                            <p>{{ ex.description }}</p>
                        </div>
                        <div class="exercise-badge" :style="{ background: getCategoryColor(ex.category) }">
                            {{ getCategoryLabel(ex.category) }}
                        </div>
                    </div>
                </div>

                <!-- Recent Workouts -->
                <div v-if="recentWorkouts.length > 0" class="recent-section">
                    <h2>Recent Workouts</h2>
                    <div class="recent-list">
                        <div v-for="(w, i) in recentWorkouts" :key="i" class="recent-item">
                            <span class="recent-name">{{ w.exerciseName }}</span>
                            <span class="recent-reps">{{ w.reps }} reps</span>
                            <span class="recent-date">{{ formatDate(w.date) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== PROFILE TAB ========== -->
            <div v-if="dashboardTab === 'profile'">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar">{{ currentUser?.charAt(0)?.toUpperCase() }}</div>
                    <div class="profile-info">
                        <h2>{{ currentUser }}</h2>
                        <p class="profile-since">Member since {{ profileStats.memberSince || 'today' }}</p>
                    </div>
                </div>

                <!-- All-time Stats -->
                <div class="stats-bar stats-bar-5">
                    <div class="stat-card">
                        <div class="stat-value">{{ profileStats.totalWorkouts }}</div>
                        <div class="stat-label">Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ profileStats.totalReps }}</div>
                        <div class="stat-label">Total Reps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ profileStats.streak }}üî•</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ profileStats.uniqueExercises }}</div>
                        <div class="stat-label">Exercises Tried</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ formatDuration(profileStats.totalDuration) }}</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>

                <!-- Extra Stats Row -->
                <div class="profile-extra-stats">
                    <div class="extra-stat" v-if="profileStats.favoriteExercise">
                        <span class="extra-label">Favorite Exercise</span>
                        <span class="extra-value">{{ profileStats.favoriteExercise }}</span>
                    </div>
                    <div class="extra-stat">
                        <span class="extra-label">Avg Reps/Workout</span>
                        <span class="extra-value">{{ profileStats.avgRepsPerWorkout }}</span>
                    </div>
                    <div class="extra-stat">
                        <span class="extra-label">Active Days</span>
                        <span class="extra-value">{{ profileStats.activeDays }}</span>
                    </div>
                </div>

                <!-- Milestones -->
                <h2 class="section-title">üèÖ Milestones <span class="milestone-count">{{ unlockedCount }}/{{
                        totalMilestones }}</span></h2>
                <div class="milestone-grid">
                    <div v-for="m in milestoneProgress" :key="m.id" class="milestone-card"
                        :class="{ unlocked: m.unlocked, locked: !m.unlocked }">
                        <div class="milestone-icon">{{ m.unlocked ? m.icon : 'üîí' }}</div>
                        <div class="milestone-info">
                            <h4>{{ m.name }}</h4>
                            <p>{{ m.description }}</p>
                        </div>
                        <div v-if="m.unlocked" class="milestone-check">‚úÖ</div>
                    </div>
                </div>

                <!-- Workout History -->
                <div v-if="recentWorkouts.length > 0" class="recent-section">
                    <h2>Workout History</h2>
                    <div class="recent-list">
                        <div v-for="(w, i) in allWorkouts" :key="i" class="recent-item">
                            <span class="recent-name">{{ w.exerciseName }}</span>
                            <span class="recent-reps">{{ w.reps }} reps</span>
                            <span class="recent-duration">{{ formatDuration(w.duration) }}</span>
                            <span class="recent-date">{{ formatDate(w.date) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== LEADERBOARD TAB ========== -->
            <div v-if="dashboardTab === 'leaderboard'">
                <div class="leaderboard-header">
                    <h2>üèÜ Leaderboard</h2>
                    <p class="leaderboard-subtitle">Rankings based on reps, workouts, streaks & milestones</p>
                </div>

                <div v-if="leaderboardData.length === 0" class="leaderboard-empty">
                    <p>No users yet. Start working out to appear on the leaderboard!</p>
                </div>

                <div class="leaderboard-list">
                    <div v-for="(user, index) in leaderboardData" :key="user.username" class="leaderboard-row"
                        :class="{ 'is-me': user.username === currentUser, 'top-3': index < 3 }">

                        <!-- Rank -->
                        <div class="lb-rank">
                            <span v-if="index === 0" class="rank-medal">ü•á</span>
                            <span v-else-if="index === 1" class="rank-medal">ü•à</span>
                            <span v-else-if="index === 2" class="rank-medal">ü•â</span>
                            <span v-else class="rank-number">#{{ index + 1 }}</span>
                        </div>

                        <!-- Avatar + Name -->
                        <div class="lb-user">
                            <div class="lb-avatar"
                                :class="{ 'avatar-gold': index === 0, 'avatar-silver': index === 1, 'avatar-bronze': index === 2 }">
                                {{ user.username.charAt(0).toUpperCase() }}
                            </div>
                            <div class="lb-name">
                                {{ user.username }}
                                <span v-if="user.username === currentUser" class="lb-you">(You)</span>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="lb-stats">
                            <div class="lb-stat">
                                <span class="lb-stat-value">{{ user.totalReps }}</span>
                                <span class="lb-stat-label">Reps</span>
                            </div>
                            <div class="lb-stat">
                                <span class="lb-stat-value">{{ user.totalWorkouts }}</span>
                                <span class="lb-stat-label">Workouts</span>
                            </div>
                            <div class="lb-stat">
                                <span class="lb-stat-value">{{ user.streak }}üî•</span>
                                <span class="lb-stat-label">Streak</span>
                            </div>
                            <div class="lb-stat">
                                <span class="lb-stat-value">{{ user.milestonesUnlocked }}/{{ user.totalMilestones
                                    }}</span>
                                <span class="lb-stat-label">Milestones</span>
                            </div>
                        </div>

                        <!-- Score -->
                        <div class="lb-score">
                            <span class="lb-score-value">{{ user.score }}</span>
                            <span class="lb-score-label">Score</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- EXERCISE PAGE                                 -->
        <!-- ============================================ -->
        <div v-if="currentPage === 'exercise'" class="exercise-page">
            <!-- Exercise Header -->
            <div class="exercise-header">
                <button @click="goBackToDashboard" class="back-btn" id="back-btn">‚Üê Back</button>
                <h2>{{ currentExerciseData?.icon }} {{ currentExerciseData?.name }}</h2>
                <span class="exercise-timer">{{ formatDuration(sessionDuration) }}</span>
            </div>

            <!-- Instruction -->
            <p class="exercise-instruction">{{ currentExerciseData?.instruction }}</p>

            <!-- Camera Container -->
            <div class="camera-container">
                <video id="webcam" ref="videoEl" autoplay playsinline></video>
                <canvas id="output-canvas" ref="canvasEl" width="1280" height="720"></canvas>

                <div v-if="isLoading" class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <p>Starting camera...</p>
                </div>

                <!-- Feedback Overlay -->
                <div class="feedback-overlay">
                    <div class="overlay-stat">
                        <div class="overlay-value">{{ repCounter }}</div>
                        <div class="overlay-label">{{ currentExerciseData?.type === 'timer' ? 'SECONDS' : 'REPS' }}
                        </div>
                    </div>

                    <div v-show="feedbackMessage" class="overlay-feedback">
                        {{ feedbackMessage }}
                    </div>

                    <div class="overlay-stat">
                        <div class="overlay-value">{{ stage }}</div>
                        <div class="overlay-label">STAGE</div>
                    </div>
                </div>

                <!-- Extra Data (for analysis modes) -->
                <div v-if="extraData" class="extra-data-overlay">
                    <div v-if="extraData.label">{{ extraData.label }}</div>
                    <div v-if="extraData.pose">Detected: {{ extraData.pose }}</div>
                    <div v-if="extraData.score !== undefined">Score: {{ extraData.score }}/100</div>
                    <div v-if="extraData.smoothness !== undefined">Smoothness: {{ extraData.smoothness }}%</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/main.js"></script>
</body>

</html>